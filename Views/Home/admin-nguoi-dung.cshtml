@{
	ViewBag.Title = ViewData["PageTitle"];
	int QuyenThem = Helper.NullToZero(ViewData["QuyenThem"]);
	int QuyenXoa = Helper.NullToZero(ViewData["QuyenXoa"]);
	int QuyenDongBo = Helper.NullToZero(ViewData["QuyenDongBo"]);
}


<link rel="stylesheet" href="~/css/nguoi_dung.css" type="text/css">
<!-- Fontawesome -->
<script src="https://kit.fontawesome.com/c29ec90d7d.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<body style="overflow:auto">
	<div class="main">
		<!-- <div class="nav_bar">
			<div class="menu">
				<button><b>Người dùng</b></button>
				<button>Tất cả</button>
				<button>Đã phân quyền</button>
				<button>Chưa phân quyền</button>
			</div>
			<div class="user">
				<i class="fa-solid fa-bell"></i>
				<div class="name_user">
					<p class="email_user"><a href="#">Admin@gmail.com</a></p>
					<p class="role_user">admin</p>
				</div>
			</div>
		</div> -->
		<div class="table">			
				<div style="padding-top: 5px;display:flex; column-gap:10px" class="menu_table">
					<button class="btn_add">
						<i class="fa-solid fa-pen-to-square"></i>
						Phân nhóm quyền
					</button>
					<div class="search0">
						<select id="ddlNhomQuyen" style="width:250px">
							<option></option>
						</select>
						<script>
							var ddlNhomChucNangData = @Html.Raw(Json.Serialize(ViewData["ddlNhomQuyen"]));
							console.log(ddlNhomChucNangData);

							$("#ddlNhomQuyen").select2({
								placeholder: "Chọn đơn vị",
								data: ddlNhomChucNangData.value,
								dropdownAutoWidth: true,
								allowClear: true
							});
						</script>
					</div>
					<div class="search0">
						<select id="ddlToChuc" style="width:250px">
							<option></option>
						</select>
						<script>
							var ddlToChucData = @Html.Raw(Json.Serialize(ViewData["ddlToChuc"]));

							$("#ddlToChuc").select2({
								placeholder: "Chọn đơn vị",
								data: ddlToChucData.value,
								dropdownAutoWidth: true,
								allowClear: true
							});
						</script>
					</div>
					<select id="ddlChucDanh" style="width: 200px;" name="">
						<option></option>
					</select>
					<script>
						var ddlChucDanhData = @Html.Raw(Json.Serialize(ViewData["ddlChucDanh"]));
						var ddlChucDanhDataArray = ddlChucDanhData.value;
						$("#ddlChucDanh").select2({
							placeholder: "Chọn đơn vị",
							data: ddlChucDanhDataArray,
							dropdownAutoWidth: true,
							allowClear: true
						});
					</script>

					<div style="padding-left:20px; " class="search">
						<input type="text" style="padding: 4px 5px;border-radius: 9px; border: 1.5px solid #696969;" placeholder="Nhập Từ Khóa">
					</div>
				</div>
			<div class="split splitfull">
				<div class="tbl" role="region" aria-labelledby="HeadersCol" tabindex="0">
					<table width="100%" id="gridbody">
						<tr class="rhead">
							<th class="colchk"><input type="checkbox" id="chkAll" onclick="setCheckAll(this);" /><span class="bdb"></span></th>
							<th width="150">Mã nhân sự<span class="bdb"></span></th>
							<th width="350">Tên đơn vị<span class="bdb"></span></th>
							<th width="150">Chức danh<span class="bdb"></span></th>
							<th width="60">Nhóm quyền<span class="bdb"></span></th>
						</tr>
						<tr>
							<td class="colchk"><input type="checkbox" /></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
						</tr>
					</table>
				</div>
			</div>
		</div>




		<div class="bg_color"></div>




		<!-- Popup edit -->
		<!-- Popup add new -->
		<div class="popup popup_add">
			<div class="navbar_popup">
				<h3>Thêm mới nhóm quyền</h3>
				<button class="btn_hidden_popup"><i class="fa-solid fa-xmark"></i></button>
			</div>
			<div class="main_popup">
				<div class="form">
					<div class="item_form">
						<label>
							<b>Mã nhóm quyền</b>
							<i class="fa-solid fa-star-of-life"></i>
						</label>
						<input type="text">
					</div>
					<div class="item_form">
						<label>
							<b>Tên nhóm quyền</b>
							<i class="fa-solid fa-star-of-life"></i>
						</label>
						<input type="text">
					</div>
					<div class="item_form">
						<label>
							<b>Số thứ tự</b>
						</label>
						<input type="number">
					</div>
					<div class="item_form">
						<label><b>Mô tả</b></label>
						<textarea name="" rows="10"></textarea>
					</div>
					<hr>
					<div class="item_btn">
						<button class="btn_save">Lưu</button>
						<button class="btn_hidden_popup">Đóng</button>
					</div>
				</div>
			</div>
		</div>


		<!-- Popup edit -->
		<div class="popup popup_edit">
			<div class="navbar_popup">
				<h3>Chỉnh sửa nhóm quyền</h3>
				<button class="btn_hidden_popup"><i class="fa-solid fa-xmark"></i></button>
			</div>
			<div class="main_popup">
				<div class="form">
					<div class="item_form">
						<label>
							<b>Mã nhóm quyền</b>
							<i class="fa-solid fa-star-of-life"></i>
						</label>
						<input type="text">
					</div>
					<div class="item_form">
						<label>
							<b>Tên nhóm quyền</b>
							<i class="fa-solid fa-star-of-life"></i>
						</label>
						<input type="text">
					</div>
					<div class="item_form">
						<label>
							<b>Số thứ tự</b>
						</label>
						<input type="number">
					</div>
					<div class="item_form">
						<label><b>Mô tả</b></label>
						<textarea name="" rows="10"></textarea>
					</div>
					<hr>
					<div class="item_btn">
						<button class="btn_save">Lưu</button>
						<button class="btn_hidden_popup">Đóng</button>
					</div>
				</div>
			</div>
		</div>


	</div>

	<!-- Phần này mình viết luôn Script vào cho gọn -->
	<script>
		// Lấy các checkbox
		const check_all = document.querySelector('.checkbox_all');
		const check_item = document.querySelectorAll('.check_item');

		// Lấy button thêm, sửa và xóa
		const btn_add = document.querySelector(".btn_add");
		const btn_edit = document.querySelector(".btn_edit");
		const btn_remove = document.querySelector(".btn_remove");
		const btn_ma_phan_quyen = document.querySelectorAll(".ma_phan_quyen");
		const btn_click_phan_quyen = document.querySelectorAll(".click_phan_quyen");
		const btn_phan_quyen = document.querySelector(".phan_quyen");
		const btn_nhan_su = document.querySelector(".btn_nhan_su");



		// Lấy popup với bbg_color
		const popup_phan_quyen = document.querySelector(".popup_phan_quyen");
		const bg_color = document.querySelector(".bg_color");
		const popup_edit = document.querySelector(".popup_edit");
		const popup_add = document.querySelector(".popup_add");



		// Scipt ẩn hiện popup
		popup_edit.style = "display:none;";
		popup_add.style = "display:none;";
		bg_color.style = "display:none;";



		// Cheack all item
		check_all.onclick = () => {
			if (check_all.checked) {
				check_item.forEach(item => {
					item.checked = true;
				});
			} else {
				check_item.forEach(item => {
					item.checked = false;
				});
			}
		}

		// btn_add
		btn_add.onclick = () => {
			popup_phan_quyen.style = "display:none;";
			popup_edit.style = "display:none;";
			popup_add.style = "display:block;";
			bg_color.style = "display:block;";

			const btn_hidden_popup = document.querySelectorAll(".btn_hidden_popup");
			btn_hidden_popup.forEach(item => {
				item.onclick = () => {
					popup_phan_quyen.style = "display:none;";
					popup_edit.style = "display:none;";
					popup_add.style = "display:none;";
					bg_color.style = "display:none;";
				}
			})


		}


		// btn_edit
		btn_edit.onclick = () => {
			popup_phan_quyen.style = "display:none;";
			popup_edit.style = "display:block;";
			popup_add.style = "display:none;";
			bg_color.style = "display:block;";

			const btn_hidden_popup = document.querySelectorAll(".btn_hidden_popup");
			btn_hidden_popup.forEach(item => {
				item.onclick = () => {
					popup_phan_quyen.style = "display:none;";
					popup_edit.style = "display:none;";
					popup_add.style = "display:none;";
					bg_color.style = "display:none;";
				}
			})


		}

		// Ẩn hiện sửa xóa
		const list_input_checkbox = document.querySelectorAll('.checkbox');

		btn_edit.disabled = true;
		btn_remove.disabled = true;
		btn_phan_quyen.disabled = true;
		btn_nhan_su.disabled = true;

		list_input_checkbox.forEach(item => {
			item.onchange = () => {
				const count_checked = document.querySelectorAll('input[type="checkbox"]:checked').length;

				btn_edit.disabled = true;
				btn_remove.disabled = true;
				btn_phan_quyen.disabled = true;
				btn_nhan_su.disabled = true;

				if (count_checked != 0) {

					btn_edit.disabled = true;
					btn_remove.disabled = false;
					btn_phan_quyen.disabled = true;
					btn_nhan_su.disabled = true;

				}
			}
		});


		btn_click_phan_quyen.forEach(item => {
			item.onclick = () => {

				btn_edit.disabled = false;
				btn_remove.disabled = true;
				btn_phan_quyen.disabled = false;
				btn_nhan_su.disabled = false;

			}
		});

		btn_phan_quyen.onclick = () => {
			popup_phan_quyen.style = "display:block;";
			bg_color.style = "display:block;";

			// Lấy button dấu x để ẩn popup
			const btn_hidden_popup = document.querySelectorAll(".btn_hidden_popup");

			btn_hidden_popup.forEach(item => {
				item.onclick = () => {
					popup_phan_quyen.style = "display:none;";
					bg_color.style = "display:none;";
				}
			});
		}



		// Thông báo lỗi hoặc thành công khi ấn lưu
	</script>
</body>
@*<div id="pagetitle">
    <h2>@ViewData["PageTitle"]</h2>
    <div id="filter" class="filter">
        <span onclick="setFilter(event,'')" class="active">Tất cả</span>
        <span onclick="setFilter(event,1)">Đang sử dụng</span>
        <span onclick="setFilter(event,0)">Không sử dụng</span>
    </div>
</div>
<input type="hidden" id="hidtotalPage" value="1" />
<input type="hidden" id="hidPageIndex" value="1" />
<input type="hidden" id="hidSuDung" value="" />
<div class="pnfilter">
    <div class="pnbnt">
        <div class="pnbtn">
            @{if (QuyenThem > 0)
                {<span class="btn" onclick="openPopup('Thêm mới đơn vị')"><img src="~/images/round_plus.png">Thêm</span>} }
            @{if (QuyenThem > 0)
                {<span class="btnhide" id="btnSua" onclick="openPopupSua('Sửa đơn vị')"><img src="~/images/pencil.png">Sửa</span>} }
            @{if (QuyenXoa > 0)
                {<span class="btnhide" id="btnXoa" onclick="XoaData()"><img src="~/images/delete.png">Xóa</span>} }
            @{if (QuyenThem + QuyenXoa > 0)
                {<span class="bdl"></span>} }
            @{if (QuyenDongBo > 0)
                {<span class="btn" onclick="popDongBo('Đồng bộ dữ liệu đơn vị')"><img src="~/images/doc_export.png">Đồng bộ dữ liệu</span>
                    <span class="bdl"></span>} }
            <div class="search0">
                <select id="ddlNhomCap" style="width:120px"><option></option></select>
                <select id="ddlToChuc" style="min-width: 250px"><option></option></select>
                <input type="text" id="txtKeyword" value="" style="width:130px" placeholder="Nhập từ khóa" />
                <script type="text/javascript">
                var ddlNhomCapData = @Html.Raw(Json.Serialize(ViewData["ddlNhomCap"]));
                $("#ddlNhomCap").select2({
                    placeholder: "Chọn cấp",
                    data: ddlNhomCapData.value,
                    allowClear: true
                });
                var ddlToChucData = @Html.Raw(Json.Serialize(ViewData["ddlToChuc"]));
                $("#ddlToChuc").select2({
                    placeholder: "Chọn đơn vị",
                    data: ddlToChucData.value,
                    dropdownAutoWidth: true,
                    allowClear: true
                });
                </script>
            </div>
            <span class="btn btnNap" onclick="NapData();"><img src="~/images/nap.png" />Nạp</span>
            <div class="pager">
                <div id="pageinfo" class="pageinfo">&nbsp;</div>
                <div class="fr">
                    <span id="gofirst" onclick="goToPage(event)">&lt;&lt;</span>
                    <span id="goprev" onclick="goToPage(event)">&lt;</span>
                    <span id="currentIndex"></span>
                    <span id="gonext" onclick="goToPage(event)">&gt;</span>
                    <span id="golast" onclick="goToPage(event)">&gt;&gt;</span>
                </div>
            </div>
            <div class="clr"></div>
        </div>
    </div>
</div>
<div class="split splitfull">
    <div class="tbl" role="region" aria-labelledby="HeadersCol" tabindex="0">
        <table width="100%" id="gridbody">
            <tr class="rhead">
                <th class="colchk"><input type="checkbox" id="chkAll" onclick="setCheckAll(this);" /><span class="bdb"></span></th>
                <th width="150">STT<span class="bdb"></span></th>
                <th width="350">Tên đơn vị<span class="bdb"></span></th>
                <th width="150">Tên rút gọn<span class="bdb"></span></th>
                <th width="60">Thứ tự<span class="bdb"></span></th>
                <th width="60">Sử dụng<span class="bdb"></span></th>
                <th width="130">Cấp<span class="bdb"></span></th>
                <th>Mô tả<span class="bdb"></span></th>
            </tr>
            <tr>
                <td class="colchk"><input type="checkbox"/></td><td></td><td></td><td></td><td></td>
            </tr>
        </table>
    </div>
</div>*@
<script>
	function openPopupSua(title) {
		var id = $("#hidIDSelected").val();
		if (id == 0 || id == null) { return; }
		if (id.length > 0) id = id.substr(1);
		openPopup(title, id);
	}
	function openPopup(title, id) {
		id = EmptyNull(id);
		new top.PopLayer({
			"title": title,
			"url": "pop-co-cau-to-chuc/" + id,
			"width": 645,
			"height": 380,
			"isModal": true,
			"moveable": false,
			"isFullScreen": false
		});
	}
	function XoaData() {
		var chks = $('#gridbody td.colchk input[type="checkbox"]:checked');
		var max = chks.length;
		if (max < 1) { return; }
		if (!confirmDeleteVN()) { return; }
		var idQuyen = $("#hidIDQuyen").val();
		var tmp = "";
		for (var i = 0; i < max; i++) {
			var row = chks[i].parentNode.parentNode;
			var id = row.id;
			var idMucTieu = id.substr(1);
			tmp = tmp + idMucTieu + ";";
		}
		var Params = {
			"tmp": tmp,
			"idQuyen": idQuyen
		};

		$.ajax({
			type: "POST",
			traditional: true,
			//async: false,
			cache: false,
			url: '/XOA_CoCauToChucJson',
			context: document.body,
			data: Params,
			success: function (result) {
				if (result.err.length > 0) {
					MessageLoi(result.err);
				}
				else {
					MessageThanhCong("Xóa dữ liệu thành công");
					LoadData();
				}
			},
			error: function (err) {
				if (err.responseText != "")
					event.preventDefault();
			}
		});
	}
	function ThanhCongThemMoi() {
		document.getElementById('myPop-close').click();
		MessageThanhCong("Thêm mới thành công");
		LoadData();
	}
	function ThanhCongSua() {
		document.getElementById('myPop-close').click();
		MessageThanhCong("Lưu dữ liệu thành công");
		LoadData();
	}
</script>
<script>
	function goToPage(e) {
		var pageIndex = parseInt($("#hidPageIndex").val());
		var totalRow = parseInt($("#hidtotalPage").val());
		switch (e.currentTarget.id) {
			case 'gofirst':
				$("#hidPageIndex").val(1);
				break;
			case 'goprev':
				if (pageIndex > 1) pageIndex = pageIndex - 1;
				$("#hidPageIndex").val(pageIndex);
				break;
			case 'gonext':
				if (pageIndex < totalRow) pageIndex = pageIndex + 1;
				$("#hidPageIndex").val(pageIndex);
				break;
			case 'golast':
				$("#hidPageIndex").val(totalRow);
				break;
		}
		LoadData();
	}
	function setFilter(e, suDung) {
		$("#hidSuDung").val(suDung);
		$("#hidPageIndex").val(1);

		var i, tabFilter;
		tabFilter = document.getElementById("filter").getElementsByTagName("span");
		for (i = 0; i < tabFilter.length; i++) {
			tabFilter[i].className = "";
		}
		e.currentTarget.className = "active";
		LoadData();
	}
	function NapData() {
		$("#hidPageIndex").val(1);
		LoadData();
	}
	function LoadData() {
		$("#hidIDSelected").val('');
		beginProgress();
		var error = $("#error");
		error.css("display", "none");
		var idQuyen = $("#hidIDQuyen").val();
		var idCocau = $("#ddlToChuc").val();
		var idNhomCap = $("#ddlNhomCap").val();
		var suDung = $("#hidSuDung").val();
		var pageIndex = $("#hidPageIndex").val();
		var keyword = $("#txtKeyword").val();
		//null:tất cả - 1: Đang sử dung - 0:không sử dụng
		var Params = {
			"idNhomCap": idNhomCap,
			"idCocau": idCocau,
			"suDung": suDung,
			"keyword": keyword,
			"pageIndex": pageIndex,
			"idQuyen": idQuyen
		};
		$.ajax({
			type: "GET",
			traditional: true,
			async: true,
			cache: false,
			url: '/co_cau_nhan_su_json',
			context: document.body,
			data: Params,
			success: function (result) {
				if (result.err.length > 0) {
					error.text(result.err);
					error.css("display", "inline");
				}
				resetTable();
				var list = result.list;
				var pager = result.pager;
				//Update pager
				var totalPage = Math.ceil(pager.totalRow / pager.pageSize);
				var fromRow = (pager.pageSize * (pageIndex - 1) + 1);
				var toRow = pager.pageSize * pageIndex;
				if (toRow > pager.totalRow) toRow = pager.totalRow;
				$("#hidtotalPage").val(totalPage);
				$("#pageinfo").text(fromRow + " - " + toRow + " trong " + pager.totalRow);
				$("#currentIndex").text(pageIndex + "/" + totalPage);

				var max = list.length;
				var tmp = "";
				for (var i = 0; i < max; i++) {
					var obj = list[i];
					var rowid = "r" + obj.idCoCau;
					var bsuDung = true;
					if (suDung == 0) { bsuDung = false; }
					if (suDung == null || suDung == '' || obj.suDung == bsuDung) {
						tmp = tmp + '<tr id="' + rowid + '" onclick="setSelect(this);">';
						tmp = tmp + '<td class="colchk"><span class="bleft"></span><input type="checkbox" onclick="BtnFire(this)"></td>';
						//tmp = tmp + '<td class="break P' + EmptyNull(obj.capBac) + '">' + EmptyNull(obj.maCoCau) + '</td>';
						tmp = tmp + '<td>' + EmptyNull(obj.maNhanSu) + '</td>';

						//tmp = tmp + '<td class="P' + EmptyNull(obj.capBac) + '">';
						//if (obj.coLopCon == true) {
						//    tmp = tmp + '<img class="exp" src="./images/arrow_down.png">';
						//}
						tmp = tmp + "<td>" + EmptyNull(obj.tenCoCau) + '</td>';

						//tmp = tmp + '<td>' + EmptyNull(obj.tenCoCauNgan) + '</td>';
						tmp = tmp + '<td>' + EmptyNull(obj.tenChucDanh) + '</td>';

						//if (obj.suDung == true)
						//    tmp = tmp + '<td class="tc"><input type="checkbox" checked="checked" onclick="return false;"/></td>';
						//else tmp = tmp + '<td class="tc"><input type="checkbox" onclick="return false;"/></td>';

						//tmp = tmp + '<td>' + EmptyNull(obj.tenNhomCap) + '</td>';

						tmp = tmp + '<td>' + '</td>';
						tmp = tmp + '</tr>';
					}
				}
				$('#progress').css({ width: 100 + '%' });
				$('#chkAll').prop('checked', false);
				$('#gridbody').append(tmp);
				endProgress();
			},
			error: function (err) {
				if (err.responseText != "")
					event.preventDefault();
			}
		});
	}
	$(document).ready(function () {
		LoadData();
	});
	function popDongBo(title) {
		new top.PopLayer({
			"title": title,
			"url": "pop-dong-bo-co-cau",
			"width": 450,
			"height": 220,
			"isModal": true,
			"moveable": false,
			"isFullScreen": false
		});
	}
	function DongBoData() {
		$("#hidIDSelected").val('');
		beginProgress();
		var error = $("#error");
		error.css("display", "none");
		var idQuyen = $("#hidIDQuyen").val();
		var idCocau = $("#ddlToChuc").val();
		var idNhomCap = $("#ddlNhomCap").val();
		var suDung = $("#hidSuDung").val();
		var pageIndex = $("#hidPageIndex").val();
		//null:tất cả - 1: Đang sử dung - 0:không sử dụng
		var Params = {
			"idNhomCap": idNhomCap,
			"idCocau": idCocau,
			"suDung": suDung,
			"pageIndex": pageIndex,
			"idQuyen": idQuyen
		};
		var reqdata = {
			"UserName": "apihap@hap.vn",
			"Password": "apihap@hap.vn"
		};
		$.ajax({
			type: "GET",
			traditional: true,
			async: true,
			cache: false,
			url: '/DongBoCoCauJson',
			context: document.body,
			data: Params,
			success: function (result) {
				if (result.err.length > 0) {
					error.text(result.err);
					error.css("display", "inline");
				}
				resetTable();
				var list = result.list;
				var pager = result.pager;
				//Update pager
				var totalPage = Math.ceil(pager.totalRow / pager.pageSize);
				var fromRow = (pager.pageSize * (pageIndex - 1) + 1);
				var toRow = pager.pageSize * pageIndex;
				if (toRow > pager.totalRow) toRow = pager.totalRow;
				$("#hidtotalPage").val(totalPage);
				$("#pageinfo").text(fromRow + " - " + toRow + " trong " + pager.totalRow);
				$("#currentIndex").text(pageIndex + "/" + totalPage);

				var max = list.length;
				var tmp = "";
				for (var i = 0; i < max; i++) {
					var obj = list[i];
					var rowid = "r" + obj.idCoCau;
					var bsuDung = true;
					if (suDung == 0) { bsuDung = false; }
					if (suDung == null || suDung == '' || obj.suDung == bsuDung) {
						tmp = tmp + '<tr id="' + rowid + '" onclick="setSelect(this);">';
						tmp = tmp + '<td class="colchk"><span class="bleft"></span><input type="checkbox" onclick="BtnFire(this)"></td>';
						tmp = tmp + '<td class="P' + EmptyNull(obj.capBac) + '"><span class="texthide">' + EmptyNull(obj.maCoCau) + '</span></td>';

						tmp = tmp + '<td class="P' + EmptyNull(obj.capBac) + '"><span class="texthide">';
						if (obj.coLopCon == true) {
							tmp = tmp + '<img class="exp" src="./images/arrow_down.png">';
						}
						tmp = tmp + EmptyNull(obj.tenCoCau) + '</span></td>';

						tmp = tmp + '<td><span class="texthide">' + EmptyNull(obj.tenCoCauNgan) + '</span></td>';

						if (obj.suDung == true)
							tmp = tmp + '<td class="tc"><input type="checkbox" checked="checked" onclick="return false;"/></td>';
						else tmp = tmp + '<td class="tc"><input type="checkbox" onclick="return false;"/></td>';

						tmp = tmp + '<td><span class="texthide">' + EmptyNull(obj.tenNhomCap) + '</span></td>';

						tmp = tmp + '<td>' + EmptyNull(obj.moTa) + '</td>';
						tmp = tmp + '</tr>';
					}
				}
				$('#progress').css({ width: 100 + '%' });
				$('#chkAll').prop('checked', false);
				$('#gridbody').append(tmp);
				endProgress();
			},
			error: function (err) {
				if (err.responseText != "")
					event.preventDefault();
			}
		});
	}
</script>